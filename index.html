<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mundo Abierto Isométrico</title>
<style>
  body {
    margin: 0; background: #cce7f0; font-family: Arial, sans-serif;
    display: flex; justify-content: center; align-items: center; height: 100vh;
  }
  #game {
    position: relative;
    width: 640px;
    height: 480px;
    background: #6b8e23;
    overflow: hidden;
    border: 2px solid #333;
  }
  /* Estilo isométrico para tiles */
  .tile {
    position: absolute;
    width: 64px;
    height: 32px;
    background: #7ec850;
    border: 1px solid #5b7a2f;
    box-sizing: border-box;
    transform: skewY(26.5deg) scaleY(0.5);
  }

  /* Personajes */
  .character {
    position: absolute;
    width: 40px;
    height: 60px;
    background: #555;
    border-radius: 8px;
    transform-origin: bottom center;
    /* Compensar para que se vea isométrico */
    transform: skewY(26.5deg) scaleY(0.5);
  }
  #player {
    background-color: #0044cc;
    z-index: 100;
  }
  #npc {
    background-color: #cc4400;
    z-index: 90;
  }

  /* Dialogo */
  #dialog {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255 255 255 / 0.9);
    border-top: 2px solid #333;
    padding: 10px;
    box-sizing: border-box;
    font-size: 16px;
    display: none;
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body>
  <div id="game"></div>
  <div id="dialog"></div>

<script>
  const game = document.getElementById('game');
  const dialog = document.getElementById('dialog');

  // Configuración del mapa isométrico (simple 8x8)
  const mapWidth = 8;
  const mapHeight = 8;
  const tileWidth = 64;
  const tileHeight = 32;

  // Crear tiles isométricos
  function createTile(x, y) {
    const tile = document.createElement('div');
    tile.classList.add('tile');

    // Posición isométrica (convertir coords cartesianas a isométricas)
    const isoX = (x - y) * (tileWidth / 2) + game.clientWidth / 2 - tileWidth / 2;
    const isoY = (x + y) * (tileHeight / 2);

    tile.style.left = isoX + 'px';
    tile.style.top = isoY + 'px';

    game.appendChild(tile);
  }

  // Generar mapa
  for(let y=0; y < mapHeight; y++) {
    for(let x=0; x < mapWidth; x++) {
      createTile(x,y);
    }
  }

  // Personajes
  function createCharacter(id, x, y, color) {
    const el = document.createElement('div');
    el.id = id;
    el.classList.add('character');
    el.style.backgroundColor = color;
    game.appendChild(el);
    return {el, x, y};
  }

  // Crear jugador y NPC en coords cartesianas (x,y)
  let player = createCharacter('player', 3, 3, '#0044cc');
  let npc = createCharacter('npc', 5, 4, '#cc4400');

  // Función para actualizar posición en pantalla según coords isométricas
  function updatePosition(char) {
    const isoX = (char.x - char.y) * (tileWidth / 2) + game.clientWidth / 2 - char.el.clientWidth/2;
    const isoY = (char.x + char.y) * (tileHeight / 2) - char.el.clientHeight + tileHeight/2;
    char.el.style.left = isoX + 'px';
    char.el.style.top = isoY + 'px';
  }

  updatePosition(player);
  updatePosition(npc);

  // Controles
  const keys = {ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false, w:false, a:false, s:false, d:false};

  window.addEventListener('keydown', e => {
    if (e.key in keys) {
      keys[e.key] = true;
      e.preventDefault();
    }
    if (e.key.toLowerCase() === 'e') {
      interact();
    }
  });
  window.addEventListener('keyup', e => {
    if (e.key in keys) {
      keys[e.key] = false;
      e.preventDefault();
    }
  });

  // Movimiento con controles isométricos:
  // Vamos a mover el jugador en "coordenadas cartesianas" x,y pero en 4 direcciones diagonales
  // Por ejemplo:
  // Flecha arriba o W => y--
  // Flecha abajo o S => y++
  // Flecha izquierda o A => x--
  // Flecha derecha o D => x++

  // Pero para isométrico (x,y) representa tiles, se moverá en el mapa con límites

  function movePlayer() {
    let moved = false;
    if (keys.ArrowUp || keys.w) {
      if(player.y > 0) {
        player.y--;
        moved = true;
      }
    }
    if (keys.ArrowDown || keys.s) {
      if(player.y < mapHeight -1) {
        player.y++;
        moved = true;
      }
    }
    if (keys.ArrowLeft || keys.a) {
      if(player.x > 0) {
        player.x--;
        moved = true;
      }
    }
    if (keys.ArrowRight || keys.d) {
      if(player.x < mapWidth -1) {
        player.x++;
        moved = true;
      }
    }
    if(moved) updatePosition(player);
  }

  // Proximidad para interacción (distancia de tiles)
  function checkProximity() {
    const dx = player.x - npc.x;
    const dy = player.y - npc.y;
    const dist = Math.abs(dx) + Math.abs(dy);
    if (dist <= 1) return true;
    return false;
  }

  // Historia / diálogo
  let storyStep = 0;
  const storyLines = [
    "Hola viajero, bienvenido a este mundo isométrico.",
    "Aquí todo se ve diferente, ¿no?",
    "Tu objetivo es explorar y descubrir secretos.",
    "¡Mucha suerte en tu aventura!",
  ];

  function interact() {
    if (checkProximity()) {
      if (storyStep < storyLines.length) {
        dialog.innerHTML = storyLines[storyStep] + '<br><em>Presiona "E" para continuar...</em>';
        dialog.style.display = 'block';
        storyStep++;
      } else {
        dialog.style.display = 'none';
        storyStep = 0;
      }
    }
  }

  // Loop del juego para detectar inputs y actualizar
  function gameLoop() {
    movePlayer();
    if(!checkProximity()) dialog.style.display = 'none';
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
</script>

</body>
</html>
