<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pixel Scene — Clima & Personaje (Mike/Susan)</title>
<style>
  :root{
    --btn-bg: rgba(0,0,0,0.45);
    --btn-hover: rgba(255,255,255,0.06);
    --ui-fg: #fff;
  }
  html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:Inter,system-ui,Segoe UI,Roboto}
  #container{position:relative;display:inline-block}
  canvas{ image-rendering: pixelated; border:4px solid #444; background:#88ccee; display:block }
  /* fullscreen button */
  .top-right {
    position:absolute; top:8px; right:8px; display:flex; gap:8px; align-items:center;
  }
  .ui-btn {
    width:36px; height:36px; border-radius:8px; background:var(--btn-bg);
    display:grid; place-items:center; border:1px solid rgba(255,255,255,0.06);
    cursor:pointer; backdrop-filter: blur(4px);
  }
  .ui-btn:hover{ transform: translateY(-2px); background:var(--btn-hover) }
  .sr{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap }
  /* character selector bottom-left */
  .char-select {
    position:absolute; left:8px; bottom:8px; display:flex; gap:8px; align-items:center;
    background: rgba(0,0,0,0.30); padding:6px; border-radius:10px; border:1px solid rgba(255,255,255,0.05);
    backdrop-filter: blur(4px);
  }
  .char-btn { padding:6px 8px; background:transparent; color:var(--ui-fg); border-radius:8px; cursor:pointer; border:0; font-size:13px }
  .char-btn.active { background: rgba(255,255,255,0.08) }
  /* small weather badge top-left */
  .badge {
    position:absolute; left:8px; top:8px; padding:6px 8px; border-radius:8px; background: rgba(0,0,0,0.35);
    font-size:13px; color:var(--ui-fg); border:1px solid rgba(255,255,255,0.04);
  }
  .hint { position:absolute; left:50%; transform:translateX(-50%); bottom:8px; color:#ddd; font-size:12px; opacity:0.9; }
</style>
</head>
<body>
  <div id="container" aria-label="Escenario pixel art interactivo">
    <canvas id="game"></canvas>

    <div class="top-right" role="group" aria-label="Controles">
      <button id="fsBtn" class="ui-btn" title="Pantalla completa" aria-label="Pantalla completa"><svg viewBox="0 0 24 24" width="18" height="18" fill="#fff"><path id="fsPath" d="M7 14H5v4h4v-2H7v-2zm10 6h-4v2h6v-6h-2v4zM5 4v6h2V6h2V4H5zm12 0v2h2v2h2V4h-4z"/></svg></button>
    </div>

    <div class="badge" id="weatherBadge" aria-live="polite">Detectando clima…</div>

    <div class="char-select" role="radiogroup" aria-label="Seleccionar personaje">
      <button id="btnMike" class="char-btn active" role="radio" aria-checked="true">Mike</button>
      <button id="btnSusan" class="char-btn" role="radio" aria-checked="false">Susan</button>
    </div>

    <div class="hint">Permite ubicación para adaptar el clima. — Puedes cambiar personaje en la esquina inferior izquierda.</div>
  </div>

<script>
/* ====== CONFIG ====== */
const LOGICAL = 64;
const DEFAULT_SCALE = 4;
let SCALE = DEFAULT_SCALE;
const canvas = document.getElementById('game');
const container = document.getElementById('container');
const ctx = canvas.getContext('2d');

function applyCanvasSize(){
  const px = LOGICAL * SCALE;
  canvas.width = px; canvas.height = px;
  canvas.style.width = px + 'px'; canvas.style.height = px + 'px';
  ctx.imageSmoothingEnabled = false;
}
applyCanvasSize();

/* ====== STATE ====== */
let frame = 0;
let action = 'idle';
let actionTime = 0;
let dir = 1;
let posX = 20;
const groundY = 44;
let jumpOffset = 0, armOffset = 0, legOffset = 0, scratchOffset = 0;

/* clouds */
const clouds = [
  { x: 4, y:8, speed:0.02, w:12 },
  { x: 30, y:6, speed:0.03, w:14 },
  { x: 50, y:10, speed:0.018, w:10 }
];

/* weather state (controlled by API or fallback) */
let weather = { kind: 'unknown', temp: null, desc: '—' }; // kinds: clear, partly, cloudy, rain, snow, fog, thunder, unknown

/* effects arrays */
let rainDrops = [];
let snowFlakes = [];
let fogAlpha = 0;

/* character choice */
let character = 'mike'; // 'mike' or 'susan'

/* UI elements */
const weatherBadge = document.getElementById('weatherBadge');
const btnMike = document.getElementById('btnMike');
const btnSusan = document.getElementById('btnSusan');
const fsBtn = document.getElementById('fsBtn');
const fsPath = document.getElementById('fsPath');

/* ====== UTIL: weathercode -> kind ====== */
function mapWeatherCode(code){
  // Open-Meteo codes: https://open-meteo.com/en/docs
  if(code === 0) return 'clear';
  if(code === 1 || code === 2) return 'partly';
  if(code === 3) return 'cloudy';
  if([45,48].includes(code)) return 'fog';
  if([51,53,55,56,57].includes(code)) return 'drizzle';
  if([61,63,65,66,67,80,81,82].includes(code)) return 'rain';
  if([71,73,75,77,85,86].includes(code)) return 'snow';
  if([95,96,99].includes(code)) return 'thunder';
  return 'unknown';
}

/* ====== Weather fetch using Open-Meteo (no API key) ====== */
async function fetchWeatherAt(lat, lon){
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
                `&current_weather=true&timezone=auto`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const j = await r.json();
    if(j && j.current_weather){
      const cw = j.current_weather;
      const kind = mapWeatherCode(cw.weathercode);
      weather = { kind, temp: cw.temperature, desc: cw.weathercode };
      updateWeatherEffects();
      updateBadge();
    } else {
      weather = { kind: 'unknown', temp: null, desc: '—' };
      updateBadge();
    }
  } catch (err) {
    console.error('Weather fetch error', err);
    weather = { kind: 'unknown', temp: null, desc: 'error' };
    updateBadge();
  }
}

/* ====== Geolocation request ====== */
function requestLocationAndWeather(){
  if(!navigator.geolocation){
    weatherBadge.textContent = 'Geolocalización no soportada — mostrando clima local (estimado)';
    return;
  }
  weatherBadge.textContent = 'Solicitando ubicación…';
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    weatherBadge.textContent = 'Obteniendo clima…';
    await fetchWeatherAt(latitude, longitude);
  }, err => {
    console.warn('geolocation denied or failed', err);
    weatherBadge.textContent = 'Ubicación denegada — usando hora local';
    // fallback: keep default (only time-of-day effects)
  }, { timeout: 10000 });
}

/* ====== Adjust visual effects per weather ====== */
function updateWeatherEffects(){
  rainDrops = []; snowFlakes = []; fogAlpha = 0;
  switch(weather.kind){
    case 'rain':
    case 'drizzle':
    case 'thunder':
      // spawn raindrops
      for(let i=0;i<160;i++){
        rainDrops.push({
          x: Math.random()*LOGICAL,
          y: Math.random()*LOGICAL,
          l: 1 + Math.random()*2,
          speed: 0.8 + Math.random()*1.6
        });
      }
      break;
    case 'snow':
      for(let i=0;i<120;i++){
        snowFlakes.push({
          x: Math.random()*LOGICAL,
          y: Math.random()*LOGICAL,
          r: 0.7 + Math.random()*1.6,
          speed: 0.2 + Math.random()*0.7
        });
      }
      break;
    case 'fog':
      fogAlpha = 0.28;
      break;
    case 'partly':
    case 'cloudy':
      // more/denser clouds
      break;
    case 'clear':
    default:
      // clear sky minimal effects
      break;
  }
}

/* ====== DIBUJO: background, sun/moon, clouds, tree, ground ====== */
function getTimeOfDay(){
  const now = new Date();
  const h = now.getHours();
  if(h >=6 && h <12) return 'morning';
  if(h >=12 && h <18) return 'afternoon';
  if(h >=18 && h <21) return 'evening';
  return 'night';
}
function computeSunMoonPos(){
  const now = new Date();
  const hour = now.getHours() + now.getMinutes()/60;
  let sunVisible = (hour >=6 && hour <=18);
  let t, x, y;
  if(sunVisible){
    t = (hour - 6) / 12;
    x = 6 + t*(LOGICAL-12);
    y = 6 + Math.sin(t*Math.PI)*10;
    return { sun:true, x, y };
  } else {
    let hh = hour; if(hh < 6) hh += 24;
    t = (hh - 18) / 12;
    x = 6 + t*(LOGICAL-12);
    y = 6 + Math.sin(t*Math.PI)*10;
    return { sun:false, x, y };
  }
}

function drawBackground(timeOfDay){
  // base sky
  if(timeOfDay === 'morning') ctx.fillStyle = '#bfefff';
  else if(timeOfDay === 'afternoon') ctx.fillStyle = '#9fe3ff';
  else if(timeOfDay === 'evening') ctx.fillStyle = '#ffb86b';
  else ctx.fillStyle = '#07122a';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // evening multi-band
  if(timeOfDay === 'evening'){
    ctx.save();
    const bandH = canvas.height/6;
    ctx.fillStyle = '#ffd89b'; ctx.fillRect(0,0,canvas.width,bandH);
    ctx.fillStyle = '#ffb86b'; ctx.fillRect(0,bandH,canvas.width,bandH*2);
    ctx.fillStyle = '#9b67d3'; ctx.fillRect(0,bandH*3,canvas.width,bandH*3);
    ctx.restore();
  }

  // sun/moon
  const pos = computeSunMoonPos();
  ctx.save(); ctx.scale(SCALE,SCALE);
  if(pos.sun){
    ctx.fillStyle = '#FFF3A6'; ctx.fillRect(Math.round(pos.x)-1,Math.round(pos.y)-1,8,8);
    ctx.fillStyle = '#FFD24D'; ctx.fillRect(Math.round(pos.x),Math.round(pos.y),6,6);
  } else {
    ctx.fillStyle = '#f7f9ff'; ctx.fillRect(Math.round(pos.x),Math.round(pos.y),6,6);
    // bite
    ctx.fillStyle = (timeOfDay === 'night') ? '#07122a' : '#9b67d3';
    ctx.fillRect(Math.round(pos.x)+2,Math.round(pos.y)+1,3,3);
  }
  ctx.restore();
}

function drawCloud(cx, cy, w, timeOfDay){
  ctx.save(); ctx.scale(SCALE,SCALE);
  ctx.fillStyle = (timeOfDay === 'night') ? 'rgba(255,255,255,0.12)' : '#ffffff';
  // make denser if weather is cloudy/partly
  const alpha = (weather.kind === 'cloudy' || weather.kind === 'partly') ? 1.0 : 1.0;
  ctx.globalAlpha = alpha;
  ctx.fillRect(cx, cy+1, w-2, 2);
  ctx.fillRect(cx+1, cy, w-4, 2);
  ctx.fillRect(cx+Math.floor(w/2)-1, cy-1, 3, 2);
  ctx.restore();
}

function drawTree(timeOfDay){
  ctx.save(); ctx.scale(SCALE,SCALE);
  ctx.fillStyle = (timeOfDay === 'night') ? '#472b16' : '#6b3b1a';
  ctx.fillRect(3, groundY - 8, 2, 6);
  ctx.fillStyle = (timeOfDay === 'night') ? '#1f3f1f' : '#2e8b2e';
  ctx.fillRect(0, groundY - 14, 8, 3);
  ctx.fillRect(1, groundY - 17, 6, 3);
  ctx.fillRect(2, groundY - 19, 4, 2);
  ctx.fillStyle = (timeOfDay === 'night') ? '#2c5e2c' : '#57b957';
  ctx.fillRect(4, groundY - 16, 2, 1);
  ctx.restore();
}

function drawGround(timeOfDay){
  ctx.save(); ctx.scale(SCALE,SCALE);
  ctx.fillStyle = (timeOfDay === 'night') ? '#334d36' : '#7bc36a';
  ctx.fillRect(0, groundY, LOGICAL, LOGICAL - groundY);
  ctx.fillStyle = (timeOfDay === 'night') ? '#2a3f2b' : '#5fa854';
  ctx.fillRect(0, groundY + 4, LOGICAL, LOGICAL - (groundY+4));
  ctx.restore();
}

/* ====== Character draw (Mike / Susan) ====== */
function drawCharacter(px, py, timeOfDay){
  ctx.save(); ctx.scale(SCALE,SCALE); ctx.translate(px, py - jumpOffset);
  // shadow
  ctx.fillStyle = (timeOfDay === 'night') ? 'rgba(0,0,0,0.18)' : 'rgba(0,0,0,0.12)';
  ctx.fillRect(12,26,8,1);

  // skin
  ctx.fillStyle = '#FFD27F'; ctx.fillRect(12,4,8,8);

  // hair differences:
  if(character === 'mike'){
    ctx.fillStyle = (timeOfDay === 'night') ? '#1f2439' : '#2a2f4a';
    ctx.fillRect(12,4,8,2); // short hair
  } else { // susan: longer hair side pixel
    ctx.fillStyle = (timeOfDay === 'night') ? '#2b1f35' : '#6b2b6b';
    ctx.fillRect(11,4,10,2);
    ctx.fillRect(11,6,1,4);
  }

  // eyes (blink)
  ctx.fillStyle = '#000';
  if(!(action === 'blink' && Math.floor(frame/10)%2 === 0)){
    ctx.fillRect(14,6,1,1); ctx.fillRect(17,6,1,1);
  }

  // mouth
  ctx.fillStyle = '#9b3a3a'; ctx.fillRect(15,9,2,1);

  // body color differences
  if(character === 'mike'){
    ctx.fillStyle = (timeOfDay === 'night') ? '#25407a' : '#3366cc';
    ctx.fillRect(10,12,12,8);
    ctx.fillStyle = (timeOfDay === 'night') ? '#213560' : '#2b55a1';
    ctx.fillRect(12,14,8,4);
  } else {
    // susan shirt pink
    ctx.fillStyle = (timeOfDay === 'night') ? '#7a3a5a' : '#ff77bb';
    ctx.fillRect(10,12,12,8);
    ctx.fillStyle = (timeOfDay === 'night') ? '#5a2a43' : '#d64b95';
    ctx.fillRect(12,14,8,4);
  }

  // arms (and scratch)
  ctx.fillStyle = '#FFD27F';
  ctx.fillRect(8,12+Math.round(armOffset),2,6);
  if(action === 'scratch'){
    ctx.fillRect(22,8+Math.round(scratchOffset),2,6);
  } else {
    ctx.fillRect(22,12-Math.round(armOffset),2,6);
  }

  // legs + boots
  ctx.fillStyle = (timeOfDay === 'night') ? '#2b2b2b' : '#444';
  ctx.fillRect(12,20-Math.round(legOffset),3,6);
  ctx.fillRect(17,20+Math.round(legOffset),3,6);
  ctx.fillStyle = '#111'; ctx.fillRect(12,25,3,1); ctx.fillRect(17,25,3,1);

  ctx.restore();
}

/* ====== Weather effect draws ====== */
function drawRain(){
  ctx.save(); ctx.scale(SCALE,SCALE);
  ctx.fillStyle = 'rgba(180,210,255,0.85)';
  for(const r of rainDrops){
    ctx.fillRect(Math.round(r.x), Math.round(r.y), 1, Math.ceil(r.l));
  }
  ctx.restore();
}
function updateRain(){
  for(const r of rainDrops){
    r.y += r.speed;
    r.x -= 0.1; // slight wind
    if(r.y > LOGICAL + 2){ r.y = -2; r.x = Math.random()*LOGICAL; }
  }
}
function drawSnow(){
  ctx.save(); ctx.scale(SCALE,SCALE);
  ctx.fillStyle = 'rgba(255,255,255,0.95)';
  for(const s of snowFlakes){
    ctx.fillRect(Math.round(s.x), Math.round(s.y), Math.ceil(s.r), Math.ceil(s.r));
  }
  ctx.restore();
}
function updateSnow(){
  for(const s of snowFlakes){
    s.y += s.speed;
    s.x += Math.sin(frame/30 + s.x)*0.1;
    if(s.y > LOGICAL+2){ s.y = -2; s.x = Math.random()*LOGICAL; }
  }
}
function drawFog(){
  if(fogAlpha <= 0) return;
  ctx.save();
  ctx.globalAlpha = fogAlpha;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}

/* ====== ACTIONS ====== */
function updateAction(){
  const actions = ['idle','walk','blink','scratch','jump'];
  action = actions[Math.floor(Math.random()*actions.length)];
  actionTime = 60 + Math.floor(Math.random()*90);
  if(action === 'walk' && Math.random() > 0.6) dir *= -1;
}

/* ====== MAIN LOOP ====== */
function loop(){
  frame++;
  const timeOfDay = getTimeOfDay();

  // clouds move (slower at night)
  for(const c of clouds){
    c.x += c.speed * (timeOfDay === 'night' ? 0.6 : 1);
    if(c.x > LOGICAL + c.w) c.x = -c.w - 2;
  }

  if(actionTime > 0) actionTime--; else updateAction();

  if(action === 'walk'){
    posX += 0.12 * dir;
    armOffset = Math.sin(frame/6)*1.2;
    legOffset = Math.sin(frame/6)*1.6;
  } else { armOffset = 0; legOffset = 0; }

  scratchOffset = (action === 'scratch') ? Math.sin(frame/4)*2 : 0;
  jumpOffset = (action === 'jump') ? Math.abs(Math.sin(frame/6)*4)*(Math.sin(frame/6)>0?1:0) : 0;

  // keep inside
  const leftLimit = 6, rightLimit = LOGICAL - 20;
  if(posX < leftLimit){ posX = leftLimit; dir = 1; }
  if(posX > rightLimit){ posX = rightLimit; dir = -1; }

  // update weather particle physics
  if(rainDrops.length) updateRain();
  if(snowFlakes.length) updateSnow();

  // draw scene
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBackground(timeOfDay);

  // stars for night (soft)
  if(timeOfDay === 'night'){
    drawStarsForNight();
  } else if(timeOfDay === 'evening'){
    ctx.save(); ctx.globalAlpha = 0.25; drawStarsForNight(); ctx.restore();
  }

  // clouds
  for(const c of clouds) drawCloud(Math.round(c.x), Math.round(c.y), c.w, timeOfDay);

  // tree and ground
  drawTree(timeOfDay);
  drawGround(timeOfDay);

  // weather effects draw
  if(rainDrops.length) drawRain();
  if(snowFlakes.length) drawSnow();
  if(fogAlpha > 0) drawFog();

  // character
  drawCharacter(Math.round(posX), groundY - 28, timeOfDay);

  requestAnimationFrame(loop);
}

/* small stars function reused */
const stars = (() => {
  const arr = [];
  for(let i=0;i<60;i++){
    arr.push({ x: Math.random() * (LOGICAL - 6) + 3, y: Math.random() * (groundY - 20) + 2, r: Math.random() > 0.85 ? 1.5 : 1 });
  }
  return arr;
})();
function drawStarsForNight(){
  ctx.save(); ctx.scale(SCALE,SCALE); ctx.fillStyle = '#ffffff';
  for(const s of stars) ctx.fillRect(Math.round(s.x), Math.round(s.y), s.r, s.r);
  ctx.restore();
}

/* ====== badge update ====== */
function updateBadge(){
  const t = weather.temp !== null ? `${Math.round(weather.temp)}°C` : '';
  let label = '';
  switch(weather.kind){
    case 'clear': label = 'Despejado'; break;
    case 'partly': label = 'Parcial'; break;
    case 'cloudy': label = 'Nublado'; break;
    case 'rain': label = 'Lluvia'; break;
    case 'drizzle': label = 'Llovizna'; break;
    case 'snow': label = 'Nieve'; break;
    case 'fog': label = 'Niebla'; break;
    case 'thunder': label = 'Tormenta'; break;
    default: label = 'Hora local';
  }
  weatherBadge.textContent = `${label} ${t}`;
}

/* ====== Fullscreen & integer scaling ====== */
function computeScaleForFullscreen(){
  const maxW = window.innerWidth, maxH = window.innerHeight;
  const scale = Math.max(1, Math.floor(Math.min(maxW/LOGICAL, maxH/LOGICAL)));
  return scale;
}
function enterFullscreen(){ if(container.requestFullscreen) container.requestFullscreen(); else if(container.webkitRequestFullscreen) container.webkitRequestFullscreen(); }
function exitFullscreen(){ if(document.exitFullscreen) document.exitFullscreen(); else if(document.webkitExitFullscreen) document.webkitExitFullscreen(); }

fsBtn.addEventListener('click', ()=> {
  if(!document.fullscreenElement && !document.webkitFullscreenElement) enterFullscreen(); else exitFullscreen();
});
function updateFullscreenState(){
  const isFS = !!(document.fullscreenElement || document.webkitFullscreenElement);
  if(isFS){
    fsPath.setAttribute('d','M5 14H3v6h6v-2H5v-4zm14 6h-6v2h8v-8h-2v6zM3 4v8h2V6h4V4H3zm14 0v2h4v4h2V4h-6z');
    SCALE = computeScaleForFullscreen();
  } else {
    fsPath.setAttribute('d','M7 14H5v4h4v-2H7v-2zm10 6h-4v2h6v-6h-2v4zM5 4v6h2V6h2V4H5zm12 0v2h2v2h2V4h-4z');
    SCALE = DEFAULT_SCALE;
  }
  applyCanvasSize();
}
document.addEventListener('fullscreenchange', updateFullscreenState);
document.addEventListener('webkitfullscreenchange', updateFullscreenState);
window.addEventListener('resize', ()=> {
  if(document.fullscreenElement || document.webkitFullscreenElement){
    SCALE = computeScaleForFullscreen();
    applyCanvasSize();
  }
});

/* ====== Character buttons ====== */
btnMike.addEventListener('click', ()=> { character = 'mike'; btnMike.classList.add('active'); btnSusan.classList.remove('active'); btnMike.setAttribute('aria-checked','true'); btnSusan.setAttribute('aria-checked','false'); });
btnSusan.addEventListener('click', ()=> { character = 'susan'; btnSusan.classList.add('active'); btnMike.classList.remove('active'); btnSusan.setAttribute('aria-checked','true'); btnMike.setAttribute('aria-checked','false'); });

/* ====== init: request location + loop start ====== */
requestLocationAndWeather();
updateAction();
loop();

/* If weather state updated by API, update effects & UI */
setInterval(()=> {
  // when weather.kind changed by fetchWeatherAt, this triggers updateEffects/badge (some calls inside fetch)
  if(weather.kind){
    updateWeatherEffects();
    updateBadge();
  }
}, 2000);

</script>
</body>
</html>
